<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.0.xsd">

    <changeSet author="geekon" id="10.0-1">
        <renameTable schemaName="public" oldTableName="room_amenities" newTableName="rooms_amenities"/>
    </changeSet>
    <changeSet author="geekon" id="10.0-2">
        <createSequence sequenceName="seq_users" cycle="false" minValue="1" maxValue="9223372036854775807" startValue="1" incrementBy="1"/>
        <createTable tableName="users">
            <column name="id" type="INTEGER" defaultValueComputed="nextval('seq_users')">
                <constraints nullable="false" unique="true" primaryKey="true" primaryKeyName="users_pk"/>
            </column>
            <column name="username" type="VARCHAR(20)">
                <constraints nullable="false" unique="true" uniqueConstraintName="username_ix0"/>
            </column>
            <column name="email" type="VARCHAR(50)">
                <constraints nullable="false" unique="true" uniqueConstraintName="email_ix0"/>
            </column>
            <column name="password" type="VARCHAR(120)">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>
    <changeSet author="geekon" id="10.0-3">
        <createSequence sequenceName="seq_roles" cycle="false" minValue="1" maxValue="9223372036854775807" startValue="1" incrementBy="1"/>
        <createTable tableName="roles">
            <column name="id" type="INTEGER" defaultValueComputed="nextval('seq_roles')">
                <constraints nullable="false" unique="true" primaryKey="true" primaryKeyName="roles_pk"/>
            </column>
            <column name="name" type="VARCHAR(20)">
                <constraints nullable="false" unique="true" uniqueConstraintName="name_ix0"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="geekon" id="10.0-4">
        <createTable tableName="users_roles">
            <column name="user_id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="users_roles_pk"/>
            </column>
            <column name="role_id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="users_roles_pk"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="users_roles" constraintName="users_roles_fk0" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users" />
        <addForeignKeyConstraint baseColumnNames="role_id" baseTableName="users_roles" constraintName="users_roles_fk1" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="roles" />
    </changeSet>
    <changeSet author="geekon" id="10.0.5">
        <insert schemaName="public" tableName="roles">
            <column name="name" value="ROLE_ADMIN"/>
            <column name="name" value="ROLE_USER"/>
        </insert>
    </changeSet>
    <changeSet author="geekon" id="10.0.6">
        <dropForeignKeyConstraint baseTableName="bookings" constraintName="bookings_fk0"/>
        <dropColumn schemaName="public" tableName="bookings" columnName="customer_id"/>
    </changeSet>
    <changeSet author="geekon" id="10.0-7">
        <createSequence sequenceName="seq_bookings_customers" cycle="false" minValue="1" maxValue="9223372036854775807" startValue="1" incrementBy="1"/>
        <createTable tableName="bookings_customers">
            <column name="id" type="INTEGER" defaultValueComputed="nextval('seq_bookings_customers')">
                <constraints nullable="false" unique="true" primaryKey="true" primaryKeyName="bookings_customers_pk"/>
            </column>
            <column name="booking_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="customer_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="booking_id" baseTableName="bookings_customers" constraintName="bookings_customers_fk0" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="bookings" />
        <addForeignKeyConstraint baseColumnNames="customer_id" baseTableName="bookings_customers" constraintName="bookings_customers_fk1" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="customers" />
    </changeSet>
    <changeSet author="geekon" id="10.0-8">
        <createSequence sequenceName="seq_users_bookings" cycle="false" minValue="1" maxValue="9223372036854775807" startValue="1" incrementBy="1"/>
        <createTable tableName="users_bookings">
            <column name="id" type="INTEGER" defaultValueComputed="nextval('seq_users_bookings')">
                <constraints nullable="false" unique="true" primaryKey="true" primaryKeyName="users_bookings_pk"/>
            </column>
            <column name="user_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="booking_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="users_bookings" constraintName="users_bookings_fk0" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users" />
        <addForeignKeyConstraint baseColumnNames="booking_id" baseTableName="users_bookings" constraintName="users_bookings_fk1" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="bookings" />
    </changeSet>
    <changeSet author="geekon" id="10.0-9">
        <sql splitStatements="false">DO 'DECLARE val bool :=(SELECT usesuper FROM pg_user where usename = CURRENT_USER); BEGIN IF val = true THEN CREATE EXTENSION IF NOT EXISTS "uuid-ossp"; END IF; END';</sql>
    </changeSet>
    <changeSet author="geekon" id="10.0-10">
        <createTable tableName="files">
            <column name="id" type="${uuid_type}" defaultValueComputed="${uuid_function}">
                <constraints nullable="false" unique="true" primaryKey="true" primaryKeyName="files_pk"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="data" type="BYTEA">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="geekon" id="10.0-11">
        <addColumn schemaName="public" tableName="users">
            <column name="image_id" type="${uuid_type}"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="image_id" baseTableName="users" constraintName="users_fk0" deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="files" />
    </changeSet>
    <changeSet author="geekon" id="10.0-12">
        <createSequence sequenceName="seq_refresh_tokens" cycle="false" minValue="1" maxValue="9223372036854775807" startValue="1" incrementBy="1"/>
        <createTable tableName="refresh_tokens">
            <column name="id" type="INTEGER" defaultValueComputed="nextval('seq_refresh_tokens')">
                <constraints nullable="false" unique="true" primaryKey="true" primaryKeyName="refresh_tokens_pk"/>
            </column>
            <column name="token" type="VARCHAR(512)">
                <constraints nullable="false" unique="true" uniqueConstraintName="token_ix0"/>
            </column>
            <column name="expiry_date" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="refresh_tokens" constraintName="refresh_tokens_fk0" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users" />
    </changeSet>
    <changeSet author="geekon" id="10.0-13">
        <addColumn schemaName="public" tableName="additional_services">
            <column name="desc" type="VARCHAR(512)"/>
        </addColumn>
        <update schemaName="public" tableName="additional_services">
            <column name="desc"
                    type="VARCHAR(512)"
                    value="Each breakfast pack includes: cereal, milk, juice, fruit pot. Served to bed at 9 a.m."/>
            <where>id = 1</where>
        </update>
        <update schemaName="public" tableName="additional_services">
            <column name="desc"
                    type="VARCHAR(512)"
                    value="Our bistro offers plenty of tasty meals, plus rotating specials. Our menu includes a range of dishes; from salads to steaks and your typical pub classics. With our lunch &amp; dinner pack you can choose what you want."/>
            <where>id = 2</where>
        </update>
        <update schemaName="public" tableName="additional_services">
            <column name="desc"
                    type="VARCHAR(512)"
                    value="With our additional cleaning service you are able to get your clothes washed every time you feel the need."/>
            <where>id = 3</where>
        </update>
        <update schemaName="public" tableName="additional_services">
            <column name="desc"
                    type="VARCHAR(512)"
                    value="If you stay with a child under 13 years old, you can order an additional bed. No other costs."/>
            <where>id = 4</where>
        </update>
    </changeSet>
    <changeSet author="geekon" id="10.0-14">
        <addColumn schemaName="public" tableName="users">
            <column name="status" type="VARCHAR(6)" defaultValue="ACTIVE">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet author="geekon" id="10.0-15">
        <addNotNullConstraint tableName="additional_services" columnName="price"/>
    </changeSet>
</databaseChangeLog>